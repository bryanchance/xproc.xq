<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>spectrum.flat.xsl</title><link rel="stylesheet" type="text/css" href="theme.css"></link></head><body><div><pre class="spectrum"><span class="z">&lt;?</span><span class="pi">xml version="1.0" encoding="utf-8"</span><span class="z">?&gt;</span><span class="txt">
</span><span class="z">&lt;!--</span><span class="cm">
XMLSpectrum by Phil Fearon Qutoric Limited 2012 (c)
http://qutoric.com
License: Apache 2.0 http://www.apache.org/licenses/LICENSE-2.0.html

Purpose: Syntax highlighter for XPath (text), XML, XSLT and XSD 1.1 file formats

Usage:

The 3 Entry point functions:

1. f:render(xml-content, is-xml, root-prefix)

description:

    Converts the xml content string to a sequence of span elements. with each
    containing a class attribute used for coloring with CSS. 

params:
    xml-content: string containing well-balanced XML extract - namespace and prefix
                 declarations not required in the string itself
    is-xsl:      boolean specifying whether coloring is for XSLT, if this is false
                 then XSD 1.1 coloring scheme is used instead
    root-prefix: string prefix used for elements requiring special coloring for XSLT
                 or XSD 1.1 - often 'xsl' and 'xs'      

2. loc:showXPath(text-content)

description:

    Converts the xpath content string to a sequence of span elements. with each
    containing a class attribute used for coloring with CSS. 

params:
   text-content: string containing a single XPath expression

3. f:get-css(is-light-theme)

description:

    Generates a CSS file used to colorise span elements generates by the previous 2 functions
    The colors generated depend on whether a light or dark them is specified with the is-light-theme
    parameter. The color theme uses the 'Solarized' color points specified at: http://ethanschoonover.com/solarized 

params:
    is-light-theme: boolean indicating whether to generate colors for a light or dark background. 

</span><span class="z">--&gt;</span><span class="txt">

</span><span class="es">&lt;</span><span class="enxsl">xsl:stylesheet</span><span class="z"> </span><span class="atn">version</span><span class="atneq">=</span><span class="z">"</span><span class="av">2.0</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xsl</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/XSL/Transform</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xs</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/2001/XMLSchema</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:loc</span><span class="atneq">=</span><span class="z">"</span><span class="av">com.qutoric.sketchpath.functions</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:css</span><span class="atneq">=</span><span class="z">"</span><span class="av">css-defs.com</span><span class="z">"</span><span class="z">
                </span><span class="atn">exclude-result-prefixes</span><span class="atneq">=</span><span class="z">"</span><span class="av">loc f xs css</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns</span><span class="atneq">=</span><span class="z">"</span><span class="av"></span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:f</span><span class="atneq">=</span><span class="z">"</span><span class="av">internal</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
  
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">sourcepath</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">light-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">css-path</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> Entry point for rendering an XML string with embedded XPath </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:render</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">xmlText</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">is-xsl</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">root-prefix-a</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="z"> </span><span class="atneq">= </span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$root-prefix-a</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> 
                            </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="whitespace">
                            </span><span class="op">else</span><span class="whitespace"> </span><span class="function">concat</span><span class="parenthesis">(</span><span class="variable">$root-prefix-a</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">tokens-a</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">tokenize</span><span class="parenthesis">(</span><span class="variable">$xmlText</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">normalize-space</span><span class="parenthesis">(</span><span class="variable">$tokens-a</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="function">subsequence</span><span class="parenthesis">(</span><span class="variable">$tokens-a</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$tokens-a</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:iterateTokens</span><span class="parenthesis">(</span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="op">,</span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$is-xsl</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$spans</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:indent</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z">
        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:indentSpans</span><span class="parenthesis">(</span><span class="whitespace">
                </span><span class="variable">$spans</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">3</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:indentSpans</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">margin</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">i</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">span</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$spans</span><span class="filter">[</span><span class="variable">$i</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">class</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$span</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">level2</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">scx</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                                        </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">ez</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                                        </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$level</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">outdent</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$spans</span><span class="filter">[</span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">ez</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">offset2</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">0</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">txt</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">le</span><span class="whitespace"> </span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$spans</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:indentSpans</span><span class="parenthesis">(</span><span class="variable">$spans</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$i</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$level2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$margin</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$offset2</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:get-css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">is-light-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="type">document</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="step">/</span><span class="qname">xsl:stylesheet</span><span class="step">/</span><span class="qname">css:theme</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">is-light-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$is-light-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:apply-templates</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:get-xslt-names</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z">
        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$a</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">variable</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">param</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="function">concat</span><span class="parenthesis">(</span><span class="variable">$prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$a</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:get-xslt-fnames</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z">
        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$a</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">template</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">function</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="function">concat</span><span class="parenthesis">(</span><span class="variable">$prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$a</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:get-xsd-names</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z">
        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$a</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">assert</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="function">concat</span><span class="parenthesis">(</span><span class="variable">$prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$a</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:get-xsd-fnames</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z">
        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$a</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">element</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">attribute</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="function">concat</span><span class="parenthesis">(</span><span class="variable">$prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$a</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname">css:background</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">is-light-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-light-theme</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">light</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">dark</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:getTagType</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">token</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">t</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">t1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$t</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">t2</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$t</span><span class="op">,</span><span class="numeric">2</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">pi</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$t2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">-</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">cm</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">!--</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$t2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">cd</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">![CDATA[</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">dt</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">cl</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="z">&lt;!--</span><span class="cm"> open tag (may be  self-closing) </span><span class="z">--&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">tg</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:expected-offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">in</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$in</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">?&amp;gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$in</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">--&amp;gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">3</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$in</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">]]&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">9</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:iterateTokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">counter</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">expected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">beganAt</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">is-xsl</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">is-xsd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">prevToken</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">nextToken</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expected</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    
    </span><span class="z">&lt;!--</span><span class="cm">
    &lt;trace&gt;
    token: &lt;xsl:value-of select="$token"/&gt;
    expected: &lt;xsl:value-of select="$expected"/&gt;
    index: &lt;xsl:value-of select="$index"/&gt;
    &lt;/trace&gt;
    
    </span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">expectedOutput</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">  looking to close an open tag </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm"> consider: &lt;!DOCTYPE person [&lt;!ELEMENT ... ]&gt; as well as reference only </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">beforeFind</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring-before</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">found</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$beforeFind</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace">
                              </span><span class="op">then</span><span class="whitespace"> </span><span class="function">true</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> 
                              </span><span class="op">else</span><span class="whitespace"> </span><span class="function">starts-with</span><span class="parenthesis">(</span><span class="variable">$beforeFind</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$found</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:expected-offset</span><span class="parenthesis">(</span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">begin-token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$beganAt</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">concat</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$begin-token</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">part-token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$begin-token</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="en">span</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">class</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:getTagType</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$beganAt</span><span class="filter">]</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> 
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">string-join</span><span class="parenthesis">(</span><span class="whitespace">
                        </span><span class="parenthesis">(</span><span class="variable">$part-token</span><span class="op">,</span><span class="whitespace">
                        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$x</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$beganAt</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$index</span><span class="whitespace"> </span><span class="numeric">-1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                        </span><span class="function">concat</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$x</span><span class="filter">]</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">
                        </span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><span class="variable">$beforeFind</span><span class="parenthesis">)</span><span class="whitespace">
                        </span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                        </span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expected</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">txt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="z">&lt;!--</span><span class="cm">
            id="{js:getStackIndex()}"&gt;
            </span><span class="z">--&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$beforeFind</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> return 2 strings if required close found - that befoe and that after (even if empty string)
     if no required close found - just return the required close</span><span class="z">--&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">parseStrings</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">char1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">requiredClose</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">char2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="numeric">2</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">?&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">-</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">--&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">]]&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt"> </span><span class="z">&lt;!--</span><span class="cm"> assume cdata: &lt;![CDATA[]]&gt; </span><span class="z">--&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">contains</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">]&gt;</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">beforeClose</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring-before</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$requiredClose</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="z">&lt;!--</span><span class="cm">
            &lt;x/&gt;
            </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="z">&lt;!--</span><span class="cm"> cdata, dtd, pi, comment, or close-tag </span><span class="z">--&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">foundClose</span><span class="z">"</span><span class="z">
                          </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace">
                                  </span><span class="op">then</span><span class="whitespace"> </span><span class="function">true</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> 
                                  </span><span class="op">else</span><span class="whitespace"> </span><span class="function">starts-with</span><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$requiredClose</span><span class="parenthesis">)</span><span class="z">"</span><span class="z">
                          </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$foundClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">tagType</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:getTagType</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string+</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">tagStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tagType</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isElementClose</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                
                </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isElementClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">ez</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">concat</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><span class="variable">$tagStart</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">tagContent</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$tagStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                
                </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isElementClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">starts-with</span><span class="parenthesis">(</span><span class="variable">$tagContent</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                                 </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">clxsl</span><span class="op">'</span><span class="whitespace">
                                 </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$tagContent</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="function">f:get-xsd-fnames</span><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">clxsl</span><span class="op">'</span><span class="whitespace">
                                 </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">cl</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                      </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tagContent</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                    </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$tagType</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                      </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tagContent</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                    </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isElementClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">ec</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isElementClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="z">&lt;!--</span><span class="cm">
                    &lt;xsl:attribute name="id" select="js:stackPop()"/&gt;
                    </span><span class="z">--&gt;</span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$requiredClose</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">txt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isElementClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="z">&lt;!--</span><span class="cm">
                    &lt;xsl:attribute name="id" select="js:getStackIndex()"/&gt;
                    </span><span class="z">--&gt;</span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$requiredClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="en">required</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$requiredClose</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="cl">required</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            
            </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">parts</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="av">&amp;quot;.*?&amp;quot;|'.*?'|[^'&amp;quot;]+|['&amp;quot;]</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="z">"</span><span class="z"> </span><span class="atn">flags</span><span class="atneq">=</span><span class="z">"</span><span class="av">s</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span class="ec">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:non-matching-substring</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:non-matching-substring</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
            
            </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">pre-text</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring-before</span><span class="parenthesis">(</span><span class="variable">$parts</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            
            </span><span class="z">&lt;!--</span><span class="cm">
            &lt;span&gt;[parts]&lt;xsl:value-of select="string-join($parts,'/')"/&gt;&lt;/span&gt;
            </span><span class="z">--&gt;</span><span class="txt">
            
            </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:getAttributes</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$parts</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$is-xsl</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            
            </span><span class="z">&lt;!--</span><span class="cm"> must be an open tag, so check for attributes </span><span class="z">--&gt;</span><span class="txt">
            
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">0</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">stillAwaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">empty</span><span class="parenthesis">(</span><span class="variable">$expectedOutput</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="function">name</span><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">required</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$parseStrings</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expectedOutput</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">newExpected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$stillAwaiting</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$expected</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$parseStrings</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">newBeganAt</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$stillAwaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$beganAt</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$index</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">le</span><span class="whitespace"> </span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:iterateTokens</span><span class="parenthesis">(</span><span class="variable">$counter</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newExpected</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newBeganAt</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$is-xsl</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:getAttributes</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">item()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">attToken</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">parts</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">is-xsl</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">is-xsd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">part1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$parts</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">part2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$parts</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">elementName</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">tokenize</span><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;|\s+|/</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">is-xsl-element</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">starts-with</span><span class="parenthesis">(</span><span class="variable">$attToken</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">es</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">&amp;lt;</span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace">
                   </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="whitespace">
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="function">f:get-xsd-fnames</span><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="whitespace"> 
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">en</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">
        id="{js:stackPush($elementName)}"&gt;
        </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$elementName</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">pre-close</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring-before</span><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"> 
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isFinalPart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$parts</span><span class="parenthesis">)</span><span class="whitespace">
                                             </span><span class="op">or</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$pre-close</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace">
                                             </span><span class="op">or</span><span class="whitespace"> </span><span class="function">starts-with</span><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z">
                  </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isFinalPart</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">  use sc class value to mark end of self-closed element </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isSelfClosed</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">ends-with</span><span class="parenthesis">(</span><span class="variable">$pre-close</span><span class="op">,</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isSelfClosed</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">sc</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">scx</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isSelfClosed</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="z">&lt;!--</span><span class="cm">
            &lt;xsl:attribute name="id" select="js:stackPop()"/&gt;
            </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isSelfClosed</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">&amp;gt;</span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">txt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isSelfClosed</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="z">&lt;!--</span><span class="cm">
            &lt;xsl:attribute name="id" select="js:getStackIndex()"/&gt;
            </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$attToken</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$pre-close</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">exists</span><span class="parenthesis">(</span><span class="variable">$part2</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm"> attribute must exist and name occurs before value, so get this first </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">left</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                              </span><span class="op">then</span><span class="whitespace"> </span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                              </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$part1</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">pre</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring-before</span><span class="parenthesis">(</span><span class="variable">$left</span><span class="op">,</span><span class="op">'</span><span class="literal">=</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">
        &lt;xsl:variable name="tokens" select="tokenize($pre, '\s+')"/&gt;
        </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:splitAttributeName</span><span class="parenthesis">(</span><span class="variable">$pre</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">attSpans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">class</span><span class="z">"</span><span class="z">
                          </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">matches</span><span class="parenthesis">(</span><span class="context">.</span><span class="op">,</span><span class="op">'</span><span class="literal">\S</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                                  </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="whitespace">
                                  </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$class</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$attSpans</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isXPath</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace">
                              </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$attSpans</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">select</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">test</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">match</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                              </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">f:get-xsd-names</span><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$attSpans</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">test</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> 
                              </span><span class="op">then</span><span class="whitespace"> </span><span class="function">true</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                              </span><span class="op">else</span><span class="whitespace"> </span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        
        </span><span class="z">&lt;!--</span><span class="cm"> for coloring attribute values that are referenced from XPath </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">metaXPathName</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                              </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="function">f:get-xslt-names</span><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">vname</span><span class="op">'</span><span class="whitespace">
                              </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="function">f:get-xslt-fnames</span><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">fname</span><span class="op">'</span><span class="whitespace">
                              </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="whitespace">
                              </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="function">f:get-xsd-fnames</span><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">fname</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">atneq</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$left</span><span class="op">,</span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$pre</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">sl</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$part2</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:double</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$part2</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">attValue</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$part2</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$sl</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isXPath</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:showXPath</span><span class="parenthesis">(</span><span class="variable">$attValue</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$is-xsl</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:processAVT</span><span class="parenthesis">(</span><span class="variable">$attValue</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$metaXPathName</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$metaXPathName</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$attValue</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$part2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$sl</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">newOffset</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$part1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$part2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$isFinalPart</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:getAttributes</span><span class="parenthesis">(</span><span class="variable">$attToken</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newOffset</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$parts</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$is-xsl</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:unescape-p</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">text</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">t1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">replace</span><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0300;</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">{{</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">replace</span><span class="parenthesis">(</span><span class="variable">$t1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0301;</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">}}</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:processAVT</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">attText</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">class</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">regex1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">\{.*?\}</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">regex2</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="qname">part</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">t1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">replace</span><span class="parenthesis">(</span><span class="variable">$attText</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\{\{</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0300;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">t2</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">replace</span><span class="parenthesis">(</span><span class="variable">$t1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\}\}</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0301;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> flags:s = match . to any char including \n </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t2</span><span class="z">"</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$regex1</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">flags</span><span class="atneq">=</span><span class="z">"</span><span class="av">s</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      
      </span><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">p</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:unescape-p</span><span class="parenthesis">(</span><span class="function">substring</span><span class="parenthesis">(</span><span class="context">.</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">{</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:showXPath</span><span class="parenthesis">(</span><span class="variable">$p</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">}</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span class="ec">&gt;</span><span class="txt">
      
      </span><span class="es">&lt;</span><span class="enxsl">xsl:non-matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">p</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">f:unescape-p</span><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$class</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$p</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:non-matching-substring</span><span class="ec">&gt;</span><span class="txt">
      
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span class="ec">&gt;</span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">f:splitAttributeName</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">text</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="av">(\S+)|(\s+)</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$text</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> css dark-theme: background color #002b36 = base 03 
   light-theme #fdf6e3 = base 3</span><span class="z">--&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="en">css:theme</span><span class="scx">&gt;</span><span class="txt">
    p.spectrum {
        margin:0px;
        font-family: monospace;
        white-space: pre-wrap;
        display: block;
        border: none thin;
        border-color: #405075;
        background-color:</span><span class="es">&lt;</span><span class="en">css:background</span><span class="z"> </span><span class="atn">dark</span><span class="atneq">=</span><span class="z">"</span><span class="av">#002b36</span><span class="z">"</span><span class="z"> </span><span class="atn">light</span><span class="atneq">=</span><span class="z">"</span><span class="av">#white</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">;
    padding: 2px;
    margin-bottom:5px;
    }
    
    .spectrum span {
        white-space: pre-wrap;
    }
    /*
    chosen theme background: </span><span class="es">&lt;</span><span class="en">css:background</span><span class="z"> </span><span class="atn">dark</span><span class="atneq">=</span><span class="z">"</span><span class="av">dark</span><span class="z">"</span><span class="z"> </span><span class="atn">light</span><span class="atneq">=</span><span class="z">"</span><span class="av">light</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">;
    
    $base03:    #002b36; //background
    $base02:    #073642; //highlighted-background
    $base01:    #586e75;
    $base00:    #657b83;
    $base0:     #839496;
    $base1:     #93a1a1;
    $base2:     #eee8d5; //highlighted-background
    $base3:     #fdf6e3; //background
    $yellow:    #b58900;
    $orange:    #cb4b16;
    $red:       #dc322f;
    $magenta:   #d33682;
    $violet:    #6c71c4;
    $blue:      #268bd2;
    $cyan:      #2aa198;
    $green:     #859900;
    */
    
    /* solorized colors */
    span.base03 {
    color: #002b36;
    }
    span.base02 {
    color: #073642;
    }
    span.base01, span.eq-equ, span.z, span.sc, span.scx, span.ec, span.es, span.ez, span.atneq {
    color: #586e75;
    }
    span.base00 {
    color: #657b83;
    }
    span.base0, span.txt, span.cd {
    color: #839496;
    }
    span.base1, span.literal, span.av {
    color:</span><span class="es">&lt;</span><span class="en">css:background</span><span class="z"> </span><span class="atn">dark</span><span class="atneq">=</span><span class="z">"</span><span class="av">#93a1a1</span><span class="z">"</span><span class="z"> </span><span class="atn">light</span><span class="atneq">=</span><span class="z">"</span><span class="av">#586e75</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">;
    }
    span.base2 {
        color: #eee8d5;
    }
    span.base3 {
        color: #fdf6e3;
    }
    span.yellow, span.op, span.type-op, span.if, span.higher, span.step {
        color: #b58900;
    }
    span.orange, span.type, span.node-type, span.function {
        color: #cb4b16;
    }
    span.red, span.fname {
        color: #dc322f;
    }
    span.magenta, span.vname, span.variable, span.external  {
        color: #d33682;
    }
    span.violet, span.qname, span.type-name, span.unclosed, span.en, span.cl {
        color: #6c71c4;
    }
    span.blue, span.enxsl, span.clxsl, span.enx, 
    span.filter, span.parenthesis, span.node{
        color: #268bd2;
    }
    span.cyan, span.atn, span.numeric, span.pi, span.dt, span.axis, span.context {
        color: #2aa198;
    }
    span.green, span.cm, span.comment {
        color: #859900;
    }
  </span><span class="ez">&lt;/</span><span class="cl">css:theme</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> xpath-colorer </span><span class="z">--&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">ops</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">, / = &amp;lt; &amp;gt; + - * ? | != &amp;lt;= &amp;gt;= &amp;lt;&amp;lt; &amp;gt;&amp;gt; //</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">aOps</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">or and eq ne lt le gt ge is to div idiv mod union intersect except in return satisfies then else</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">hOps</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">for some every</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">nodes</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">attribute comment document-node element node processing-instruction text</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">types</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">empty item node schema-attribute schema-element type</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">ambiguousOps</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">tokenize</span><span class="parenthesis">(</span><span class="variable">$aOps</span><span class="op">,</span><span class="op">'</span><span class="literal">\s+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">simpleOps</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">tokenize</span><span class="parenthesis">(</span><span class="variable">$ops</span><span class="op">,</span><span class="op">'</span><span class="literal">\s+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">nodeTests</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">tokenize</span><span class="parenthesis">(</span><span class="variable">$nodes</span><span class="op">,</span><span class="op">'</span><span class="literal">\s+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">typeTests</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">tokenize</span><span class="parenthesis">(</span><span class="variable">$types</span><span class="op">,</span><span class="op">'</span><span class="literal">\s+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">higherOps</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">tokenize</span><span class="parenthesis">(</span><span class="variable">$hOps</span><span class="op">,</span><span class="op">'</span><span class="literal">\s+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">bgColor</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">black</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  
  
  </span><span class="z">&lt;!--</span><span class="cm"> Entry point for rendering an XML file with embedded XPath </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:showXPath</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">chunk</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:stringToCharSequence</span><span class="parenthesis">(</span><span class="variable">$chunk</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">blocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:createBlocks</span><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">pbPairs</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:createPairs</span><span class="parenthesis">(</span><span class="variable">$blocks</span><span class="filter">[</span><span class="function">name</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">block</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">]</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">)</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">omitPairs</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="variable">$blocks</span><span class="filter">[</span><span class="function">name</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:getTokens</span><span class="parenthesis">(</span><span class="variable">$chunk</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$omitPairs</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$pbPairs</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:call-template</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="tcall">plain</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">para</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:call-template</span><span class="ec">&gt;</span><span class="txt">
    
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  
  </span><span class="z">&lt;!--</span><span class="cm"> //////////////////////////////////////////////////////////////////////////////////////////////// </span><span class="z">--&gt;</span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> 
   Sample output:
  &lt;block position="3" type="["/&gt;
  &lt;literal type="'" start="54" end="61"/&gt;
  &lt;comment start="65" end="69"/&gt;
  &lt;comment start="76"/&gt; // if not closed
   </span><span class="z">--&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:pad</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">padStringIn</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">fixedWidth</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">padString</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">replace</span><span class="parenthesis">(</span><span class="variable">$padStringIn</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\n</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">\\n</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">stringLength</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$padString</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">padChar</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$fixedWidth</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">20</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">.</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"> </span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">padCount</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$fixedWidth</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$stringLength</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$padCount</span><span class="whitespace"> </span><span class="op">ge</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">concat</span><span class="parenthesis">(</span><span class="variable">$padString</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-join</span><span class="parenthesis">(</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="variable">$padCount</span><span class="whitespace"> 
                            </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$padChar</span><span class="op">,</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$padCount</span><span class="whitespace"> </span><span class="op">lt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">concat</span><span class="parenthesis">(</span><span class="variable">$padString</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#10;</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal"> </span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-join</span><span class="parenthesis">(</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="variable">$fixedWidth</span><span class="whitespace"> 
                            </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$padChar</span><span class="op">,</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="tname">plain</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">para</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">total</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$para</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="variable">$total</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$para</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isJoined</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">string-length</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">ends-with</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isLiteral</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">empty</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">type</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">literalQuote</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteral</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$literalQuote</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="en">span</span><span class="scx">&gt;</span><span class="txt">
          
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">variable</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">lt</span><span class="whitespace"> </span><span class="variable">$total</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$para</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">whitespace</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$para</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="filter">]</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">in</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">id</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">concat</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">rng-</span><span class="op">'</span><span class="op">,</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
          
          </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">className</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">exists</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">type</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace">
                                      </span><span class="function">matches</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">,</span><span class="op">'</span><span class="literal">select[\n\p{Zs}]*=[\n\p{Zs}]*[&amp;quot;&amp;apos;&amp;apos;]</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                                      </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">select</span><span class="op">'</span><span class="whitespace">
                                      </span><span class="op">else</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">type</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">p</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$para</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$p</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace">
                                      </span><span class="function">matches</span><span class="parenthesis">(</span><span class="variable">$p</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">,</span><span class="op">'</span><span class="literal">name[\n\p{Zs}]*=[\n\p{Zs}]*[&amp;quot;&amp;apos;&amp;apos;]</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                                      </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">external</span><span class="op">'</span><span class="whitespace">
                                      </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">qname</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
          
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">class</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$className</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$className</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">external</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">id</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">concat</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">ext-</span><span class="op">'</span><span class="op">,</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
          
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">function</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">not</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">pair-end</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">style</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">color: pink;</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
          
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">pair-end</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">pair-end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">pair-end</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
          
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">type</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> 
                        </span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">function</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">filter</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">parenthesis</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">variable</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">node</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">not</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">)</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">]</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace">
                        </span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">*</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$para</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">axis</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">select</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">quick</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
          
          
          </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isLiteral</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="function">substring</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">value</span><span class="z">"</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="av">\n</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="en">br</span><span class="scx">&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">br</span><span class="ec">&gt;</span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span class="ec">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:non-matching-substring</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:non-matching-substring</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isJoined</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="function">substring</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">value</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
          
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isJoined</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">parenthesis</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">(</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
        
        </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteral</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$literalQuote</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
        
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname">token</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">plainLine</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="en">span</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">class</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">type</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">revChars</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">reverse</span><span class="parenthesis">(</span><span class="function">string-to-codepoints</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">lastLF</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$revChars</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="function">index-of</span><span class="parenthesis">(</span><span class="variable">$revChars</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">10</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">value</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$lastLF</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="cl">span</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname">token</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">dev</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="en">p</span><span class="scx">&gt;</span><span class="txt"></span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">p</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:stringToCharSequence</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$string</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">return</span><span class="whitespace"> </span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$string</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$i</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:createPairs</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">brackets</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">nested</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:call-template</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="tcall">getNesting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">positions</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$brackets</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">level</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">0</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">index</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:call-template</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm">  pair up start and end elements </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">ends</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$nested</span><span class="filter">[</span><span class="axis">@</span><span class="qname">end</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$nested</span><span class="filter">[</span><span class="axis">@</span><span class="qname">start</span><span class="filter">]</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">level</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">level</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">pair</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="variable">$ends</span><span class="filter">[</span><span class="axis">@</span><span class="qname">level</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$level</span><span class="filter">]</span><span class="parenthesis">)</span><span class="filter">[</span><span class="function">number</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">end</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="variable">$start</span><span class="filter">]</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="z">
                    </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="function">name</span><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">level</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$level</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pair</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pair</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="tname">getNesting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">positions</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">pos</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$positions</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isOpen</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pos</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">(:</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isBracket</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pos</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">)</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isComment</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pos</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">(:</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">:)</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">blockType</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$isBracket</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">bracket</span><span class="op">'</span><span class="whitespace">
                                           </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$isComment</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="whitespace">
                                           </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">predicate</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$isOpen</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                                          </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">empty</span><span class="parenthesis">(</span><span class="variable">$pos</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isOpen</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$blockType</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pos</span><span class="step">/</span><span class="axis">@</span><span class="qname">position</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">level</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$newLevel</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$blockType</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pos</span><span class="step">/</span><span class="axis">@</span><span class="qname">position</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">level</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$level</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$positions</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:call-template</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="tcall">getNesting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">level</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">index</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:call-template</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:createBlocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">skip</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">charCount</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$chars</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">char</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">nChar</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">pChar</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:)</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">)</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$pChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="numeric">-1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$level</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$level</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">nowAwaiting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="op">=</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;apos;&amp;apos;</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">&amp;quot;</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                                </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> 
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:)</span><span class="op">'</span><span class="whitespace"> 
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:)</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">)</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$pChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">nowSkip</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$skip</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$char</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">true</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nowAwaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">]</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">)</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="en">block</span><span class="z"> </span><span class="atn">position</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">type</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$char</span><span class="op">}</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isFound</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$nowAwaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$skip</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$nowSkip</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">newStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isFound</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$isFound</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:)</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:)</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$charCount</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$isFound</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:)</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:)</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:createBlocks</span><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowSkip</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newStart</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newLevel</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> top-level call - marks up tokens with their type </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:getTokens</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">chunk</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">omitPairs</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">pbPairs</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:createTokens</span><span class="parenthesis">(</span><span class="variable">$chunk</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$omitPairs</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:rationalizeTokens</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$pbPairs</span><span class="op">,</span><span class="whitespace"> </span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:rationalizeTokens</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">prevIsClosed</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">pbPairs</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">typeExpected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">quantifierExpected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> when closed, a probable operator is a QName instead </span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()?</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isQuantifier</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$quantifierExpected</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">*</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">currentIsClosed</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isQuantifier</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">)</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">]</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">numeric</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">variable</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">context</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">token</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">value</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      
      </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">probableOp</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$prevIsClosed</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">op</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$isQuantifier</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$prevIsClosed</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">*</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm">
          &lt;xsl:attribute name="type" select="'any'"/&gt;
          
          </span><span class="z">--&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">function</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">if</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">node</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">pair</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pbPairs</span><span class="filter">[</span><span class="axis">@</span><span class="qname">start</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$typeExpected</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">node</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">node-type</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="function">empty</span><span class="parenthesis">(</span><span class="variable">$pair</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pair</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">pair-end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pair</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">level</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$pair</span><span class="step">/</span><span class="axis">@</span><span class="qname">level</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$typeExpected</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">type-name</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isQuantifier</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">quantifier</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">ignorable</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">whitespace</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isNewClosed</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$ignorable</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$prevIsClosed</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">probableOp</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="variable">$prevIsClosed</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$currentIsClosed</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">newTypeExpected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$ignorable</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$typeExpected</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">type-op</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">le</span><span class="whitespace"> </span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">qExpected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                    </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$typeExpected</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$token</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">)</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt"> 
      
      
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:rationalizeTokens</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$isNewClosed</span><span class="op">,</span><span class="whitespace">
                            </span><span class="variable">$pbPairs</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newTypeExpected</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$qExpected</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:createTokens</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">string</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">excludes</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">exclude</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$excludes</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">empty</span><span class="parenthesis">(</span><span class="variable">$exclude</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> 
                          </span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="whitespace"> </span><span class="type-op">cast as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">exStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">empty</span><span class="parenthesis">(</span><span class="variable">$exclude</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">part</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">empty</span><span class="parenthesis">(</span><span class="variable">$exclude</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">exists</span><span class="parenthesis">(</span><span class="variable">$exStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$exStart</span><span class="whitespace"> </span><span class="op">ge</span><span class="whitespace"> </span><span class="variable">$start</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$string</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$start</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$exStart</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$start</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$string</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$start</span><span class="op">,</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$string</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$start</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$part</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                    </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:rawTokens</span><span class="parenthesis">(</span><span class="variable">$part</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      
      </span><span class="z">&lt;!--</span><span class="cm"> The XSLT that generates the tokens </span><span class="z">--&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:processTokens</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$start</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="function">empty</span><span class="parenthesis">(</span><span class="variable">$exclude</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">token</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">stringEnd</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$string</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">value</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">substring</span><span class="parenthesis">(</span><span class="variable">$string</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$stringEnd</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$exclude</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:attribute</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">name</span><span class="parenthesis">(</span><span class="variable">$exclude</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> iterate 1 pos beyond end of excludes length </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">not</span><span class="parenthesis">(</span><span class="function">empty</span><span class="parenthesis">(</span><span class="variable">$excludes</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="function">not</span><span class="parenthesis">(</span><span class="function">empty</span><span class="parenthesis">(</span><span class="variable">$end</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">le</span><span class="whitespace"> </span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$excludes</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:createTokens</span><span class="parenthesis">(</span><span class="variable">$string</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$excludes</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:processTokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">token</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">token</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$end</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">value</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isSimpleOps</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$simpleOps</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isSimpleOps</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">//</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">step</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">op</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">isDoubleToken</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isSimpleOps</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">splitToken</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                          </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">tokenize</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">[\n\p{Zs}]+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$splitToken</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                        </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$splitToken</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">instance</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$splitToken</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">of</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> 
                        </span><span class="op">then</span><span class="whitespace"> </span><span class="function">true</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                        </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$splitToken</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">cast</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">castable</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">treat</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$splitToken</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">as</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                        </span><span class="op">then</span><span class="whitespace"> </span><span class="function">true</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="function">false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isDoubleToken</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">type-op</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
      
      </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">functionType</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isSimpleOps</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$isDoubleToken</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="function">string-length</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="function">not</span><span class="parenthesis">(</span><span class="function">ends-with</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname">fnName</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">tokenize</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">[\n\p{Zs}]+|\(</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$fnName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">if</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">if</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="higher">some</span><span class="whitespace"> </span><span class="variable">$n</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$nodeTests</span><span class="whitespace"> </span><span class="op">satisfies</span><span class="whitespace"> </span><span class="variable">$n</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$fnName</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">node</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="higher">some</span><span class="whitespace"> </span><span class="variable">$x</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$typeTests</span><span class="whitespace"> </span><span class="op">satisfies</span><span class="whitespace"> </span><span class="variable">$x</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$fnName</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">type</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">function</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span class="ec">&gt;</span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isSimpleOps</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$isDoubleToken</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$functionType</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$functionType</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">ends-with</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">::</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$token</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">@</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">axis</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">matches</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="op">'</span><span class="literal">[\n\p{Zs}]+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">whitespace</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">.</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">..</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">context</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">)</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">parenthesis</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">]</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">filter</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">number</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="function">number</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">numeric</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$ambiguousOps</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">probableOp</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$higherOps</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">starts-with</span><span class="parenthesis">(</span><span class="function">loc:nextNonWhite</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">$</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">higher</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">if</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:nextNonWhite</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">(</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">if</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">starts-with</span><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">$</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">variable</span><span class="op">'</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span class="ec">&gt;</span><span class="txt">
    
    </span><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">le</span><span class="whitespace"> </span><span class="function">count</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">loc:processTokens</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:nextNonWhite</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="function">true</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="z">&lt;!--</span><span class="cm"> test="$index + 2 lt count($tokens)"&gt;  </span><span class="z">--&gt;</span><span class="txt"> 
        </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="function">replace</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="op">,</span><span class="op">'</span><span class="literal">[\n\p{Zs}]+</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                              </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span class="ec">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  </span><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname">loc:rawTokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname">chunk</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
    </span><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z">
        </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="av">(((-)?\d+)(\.)?(\d+([eE][\+\-]?)?\d*)?)|(\?)|(instance[\n\p{{Zs}}]+of)|(cast[\n\p{{Zs}}]+as)|(castable[\n\p{{Zs}}]+as)|(treat[\n\p{{Zs}}]+as)|((\$[\n\p{{Zs}}]*)?[\i\*][\p{{L}}\p{{Nd}}\.\-]*(:[\p{{L}}\p{{Nd}}\.\-\*]*)?(::)?:?)(\()?|(\.\.)|((-)?\d?\.\d*)|-|([&amp;lt;&amp;gt;!]=)|(&amp;gt;&amp;gt;|&amp;lt;&amp;lt;)|(//)|([\n\p{{Zs}}]+)|(\C)</span><span class="z">"</span><span class="z">
        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chunk</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="function">string</span><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="z">"</span><span class="sc">/&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span class="ec">&gt;</span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span class="ec">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span class="ec">&gt;</span><span class="txt">
  
  
</span><span class="ez">&lt;/</span><span class="clxsl">xsl:stylesheet</span><span class="ec">&gt;</span><span class="txt">
</span></pre></div></body></html>